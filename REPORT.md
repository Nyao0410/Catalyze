# Flutterプロジェクト構造分析レポート

## 全体アーキテクチャ

このFlutterプロジェクトは、明確な責務分離を持つレイヤードアーキテクチャを採用しています。UI層（`screens`, `widgets`）、ビジネスロジック層（`services`）、データモデル層（`models`）が明確に分離されており、保守性と拡張性が高い設計となっています。

バックエンドサービスにはFirebaseが利用されており、認証（Firebase Authentication）とデータ永続化（Firebase Firestore）に活用されています。これにより、スケーラブルで堅牢なアプリケーション基盤が提供されています。

特に、`auth_gate.dart`の存在は、アプリケーションの起動時に認証状態を一元的に管理し、ユーザー体験を向上させるための重要なコンポーネントとして機能しています。

## ディレクトリ構造と各責務

`lib`ディレクトリは、以下のサブディレクトリとファイルで構成され、それぞれの責務が明確に定義されています。

-   **`lib/`**: アプリケーションのソースコードのルート。
    -   `auth_gate.dart`: アプリケーションの認証状態を管理し、ユーザーのログイン状態に基づいて適切な画面（ログイン画面またはメインコンテンツ）にルーティングする役割を担うウィジェット。`AuthService` を介してFirebase Authenticationの認証状態の変更を監視します。
    -   `firebase_options.dart`: Firebase CLIによって自動生成されるファイルで、各プラットフォーム（Web, Android, iOS, macOS, Windows）ごとのFirebaseプロジェクト設定（APIキー、App ID、プロジェクトIDなど）を定義します。アプリケーションがFirebaseサービスと連携するために必要な設定情報を提供します。
    -   `main.dart`: Flutterアプリケーションのエントリーポイント。`main` 関数でFirebaseの初期化を行い、`runApp` でアプリケーションのルートウィジェット (`MyApp`) を起動します。`MyApp` はアプリケーションのタイトル、テーマ設定、および最初の画面 (`AuthGate`) を定義します。
    -   `main_scaffold.dart`: アプリケーションの主要なナビゲーション構造（ボトムナビゲーションバー）と、それに連動する画面の切り替えを管理するウィジェット。ホーム、分析、設定の各画面を切り替えるためのコンテナとして機能します。

-   **`lib/constants/`**: アプリケーション全体で使用される定数を定義します。
    -   `app_sizes.dart`: アプリケーション全体で使用されるUIのサイズに関する定数を定義します。パディング、マージン、コーナーの丸み、ウィジェット間のスペース（`gapW`、`gapH`）など、デザインの一貫性を保つための数値を提供します。これにより、マジックナンバーを避け、UIの調整を容易にします。
    -   `app_theme.dart`: アプリケーションのライトテーマとダークテーマを定義します。`ColorScheme`、`textTheme`、`appBarTheme` などのプロパティを設定し、アプリケーション全体で一貫したデザインとブランドイメージを適用できるようにします。`GoogleFonts` を使用してカスタムフォントを適用しています。

-   **`lib/models/`**: アプリケーションのデータ構造を定義するDartクラスを含みます。
    -   `learning_record.dart`: 個々の学習記録を表すデータモデル。ポモドーロタイマーのセッション終了時や手動での記録時に生成され、Firestoreに保存されます。学習量 (`amount`), 単位 (`unit`), 学習時間 (`durationInMinutes`), 日付 (`date`), ポモドーロ回数 (`ptCount`), 集中度 (`concentrationLevel`), 難易度 (`difficulty`) などの情報を含みます。Firestoreとの間でデータを変換するための `fromMap` および `toMap` メソッドを提供します。
    -   `study_plan.dart`: 学習計画を表すデータモデル。ユーザーが設定する学習目標（例: 参考書名、総量、単位、目標達成日、優先度など）を保持します。進捗管理のための `completedAmount` や、計画の編集を容易にする `copyWith` メソッドも提供します。Firestoreとの間でデータを変換するための `fromMap` および `toMap` メソッドを提供します。
    -   `user_settings.dart`: ユーザー固有の設定を保持するデータモデル。日ごとの学習目標 (`dailyGoalInPT`) や、学習を好む曜日 (`preferredStudyDays`) などの情報を含みます。Firestoreとの間でデータを変換するための `fromMap` および `toMap` メソッドを提供します。

-   **`lib/screens/`**: アプリケーションの各画面（ページ）に対応するUIウィジェットを格納します。
    -   `analysis_screen.dart`: 学習データの分析結果を表示する画面。週間学習グラフと参考書ごとの学習バランス円グラフを提供します。`PlanService` を介して分析データを取得し、`WeeklyBarChart` と `BookBalancePieChart` ウィジェットを使用して視覚化します。
    -   `learning_screen.dart`: 学習アクティビティを行うための画面。現在「準備中」のプレースホルダーが表示されています。
    -   `login_screen.dart`: ユーザーがメールアドレスとパスワードでログインするための画面。ログインフォーム、エラー表示、ローディングインジケータ、サインアップ画面への遷移ボタンを提供します。
    -   `plan_creation_screen.dart`: 新しい学習計画を作成、または既存の学習計画を編集するためのフォーム画面。参考書名、総量、単位、予測PT、目標日、説明、優先度などを入力できます。
    -   `plan_detail_screen.dart`: 特定の学習計画の詳細を表示し、ポモドーロタイマーと学習記録のリストを提供する画面。タイマー終了時や完了ボタン押下時に、学習記録の入力とFirestoreへの保存を行う `EvaluationScreen` へ遷移します。
-   `settings_screen.dart`: アプリケーションの設定を行うための画面。現在「準備中」のプレースホルダーが表示されており、ログアウト機能を提供します。
-   `signup_screen.dart`: ユーザーが新しいアカウントを作成するための画面。サインアップフォーム、エラー表示、ローディングインジケータ、ログイン画面への遷移ボタンを提供します。
-   **`lib/screens/home/`**: ホーム画面に関連するウィジェット。
    -   `home_screen.dart`: アプリケーションのメイン画面。全体の学習進捗度と学習計画のリストを表示します。ユーザーはここからログアウトできます。
-   **`lib/screens/plan/`**: 学習計画に関連するウィジェット。
    -   `plan_list_screen.dart`: 登録されているすべての学習計画のリストを表示する画面。各計画をタップすると詳細画面へ遷移し、フローティングアクションボタンから新しい計画を作成できます。
-   **`lib/screens/evaluation_screen.dart`**: 学習記録の入力と評価を行う画面。ポモドーロタイマー終了時や学習計画完了時に遷移し、進捗量と集中度、難易度を入力してFirestoreに保存します。

-   **`lib/services/`**: **基本精神1: サービス層アーキテクチャ** の中心となるディレクトリです。ビジネスロジック、データ取得、外部サービス（Firebaseなど）との連携をカプセル化します。これにより、UI層からビジネスロジックが分離され、テスト容易性と再利用性が向上します。
    -   `auth_service.dart`: Firebase Authentication を利用した認証関連のすべてのロジックをカプセル化します。ユーザーのサインアップ、ログイン、ログアウト、および認証状態のリアルタイム監視機能を提供します。UI層からはこのサービスを通じて認証操作を行い、Firebaseの低レベルなAPIを直接扱う必要がありません。
    -   `plan_service.dart`: Firebase Firestore を利用した学習計画 (`StudyPlan`) および学習記録 (`LearningRecord`) のデータ操作に関するすべてのロジックをカプセル化します。学習計画の追加、更新、削除、取得（ストリーム）、学習記録の追加、週間学習データや参考書ごとの学習バランスデータの取得など、データ永続化とビジネスロジックを提供します。`getOverallProgress()` メソッドは、今日の総日割り目標と今日の総完了量を返すように変更されました。また、学習計画と学習記録から日割り目標などの情報を計算する `calculateDailyQuotaInfo` 関数も提供します。ユーザーごとのデータ分離もこのサービスで管理されます。

-   **`lib/widgets/`**: アプリケーション全体で再利用可能なUIコンポーネントを格納します。
    -   `app_logo.dart`: アプリケーションのロゴ（アイコンとテキスト）を表示するシンプルなウィジェット。
    -   `error_display.dart`: エラーメッセージとエラーアイコンを表示する汎用的なウィジェット。
    -   `plan_card.dart`: 個々の学習計画の詳細（進捗率、残り日数、日割り目標など）を表示するカードウィジェット。学習記録のストリームを監視し、進捗をリアルタイムで更新します。日割り目標などの計算ロジックは `PlanService` に分離されました。計画の編集・削除機能も提供します。
    -   `pomodoro_timer.dart`: ポモドーロタイマー機能を提供するウィジェット。集中時間と休憩時間を管理し、タイマーの開始、一時停止、リセット機能を提供します。タイマー終了時にはコールバックを呼び出します。
    -   `secondary_button.dart`: アプリケーション全体で一貫したデザインのセカンダリボタン。
    -   **`lib/widgets/analysis/`**: 分析画面固有のウィジェット。
        -   `book_balance_pie_chart.dart`: 学習バランスを円グラフで視覚化するウィジェット。各学習項目（参考書など）に費やした時間の割合を表示します。
        -   `weekly_bar_chart.dart`: 週間学習データを棒グラフで表示するウィジェット。学習量または学習時間の推移を曜日ごとに視覚化します。
    -   **`lib/widgets/common/`**: 汎用的な共通ウィジェット。
        -   `loading_indicator.dart`: データロード中などに表示される汎用的なローディングインジケータ。
        -   `primary_button.dart`: アプリケーション全体で一貫したデザインのプライマリボタン。ローディング状態も表示可能。
    -   **`lib/widgets/home/`**: ホーム画面固有のウィジェット。
        -   `overall_progress_card.dart`: 全体の学習進捗度をパーセンテージとプログレスバーで表示するカードウィジェット。`PlanService` を介して今日のノルマ達成率（amountベース）を表示するように変更されました。
        -   `plan_list_preview.dart`: ホーム画面で学習計画のリストをプレビュー表示するウィジェット。`PlanService` を介してFirebaseから学習計画のストリームを取得し、`PlanCard` を使用して各計画を表示します。

## 認証フロー

**基本精神2: 認証フローの重要性** に基づき、このプロジェクトでは認証フローがアプリケーションの中心的な要素として設計されています。

1.  **エントリーポイント**: `main.dart`でFirebaseが初期化された後、アプリケーションのルートウィジェットとして`AuthGate`が設定されます。
2.  **認証状態の監視**: `AuthGate`は、`auth_service.dart`（またはFirebase Authenticationのストリーム）を通じてユーザーの認証状態を継続的に監視します。
3.  **ルーティング制御**:
    -   ユーザーが未認証の場合、`AuthGate`は自動的に`LoginScreen`または`SignupScreen`へナビゲートします。
    -   ユーザーが認証済みの場合、`AuthGate`はアプリケーションのメインコンテンツ（例: `MainScaffold`を介したホーム画面）へナビゲートします。
4.  **サービス層による抽象化**: `auth_service.dart`は、ログイン、サインアップ、ログアウトなどの認証操作を抽象化し、UI層からFirebase Authenticationの詳細を隠蔽します。これにより、認証ロジックが一元化され、変更やテストが容易になります。

この明確な認証フローの分離と管理は、セキュリティとユーザーエクスペリエンスの両面でアプリケーションの堅牢性を高めています。

## flutter analyze 結果

```
No issues found!
```