# データベーススキーマ移行ガイド

このドキュメントは、アプリケーションのデータベーススキーマを変更する際の手順、後方互換性の維持、およびデータ移行戦略について説明します。

## 1. スキーマ変更時の基本手順

新しいスキーマバージョンを導入する際は、以下の手順に従ってください。

1.  **新しいスキーマバージョンの定義**: `StudyPlan` モデル（または関連するデータモデル）に `schemaVersion` フィールドを追加し、新しいバージョン番号を定義します。
    例:
    ```dart
    class StudyPlan {
      // ... 既存のフィールド ...
      final int schemaVersion; // 新しいフィールド
      // ...
    }
    ```
2.  **データモデルの更新**: 新しいフィールドの追加、既存フィールドの型変更、フィールド名の変更など、必要なデータモデルの変更を行います。
3.  **マイグレーションロジックの実装**:
    *   `Repository` 実装（例: `InMemoryRepository`, `FirestoreRepository`）内で、古いスキーマバージョンのデータを新しいスキーマに変換するロジックを実装します。
    *   これは通常、データを読み込む際に `schemaVersion` をチェックし、必要に応じて変換処理を行う形になります。
    *   例:
        ```dart
        // Repository のどこかで
        Future<StudyPlan> getStudyPlan(String planId) async {
          // ... データをフェッチ ...
          if (fetchedPlan.schemaVersion < currentSchemaVersion) {
            return _migratePlan(fetchedPlan, currentSchemaVersion);
          }
          return fetchedPlan;
        }

        StudyPlan _migratePlan(StudyPlan oldPlan, int targetVersion) {
          StudyPlan migratedPlan = oldPlan;
          if (oldPlan.schemaVersion < 2 && targetVersion >= 2) {
            // v1 -> v2 への移行ロジック
            migratedPlan = migratedPlan.copyWith(
              // 新しいフィールドのデフォルト値設定や変換
              newField: 'default_value',
              schemaVersion: 2,
            );
          }
          // ... 他のバージョンへの移行ロジック ...
          return migratedPlan;
        }
        ```
4.  **テストの追加**: マイグレーションロジックが正しく機能することを確認するためのユニットテストおよび統合テストを追加します。

## 2. 後方互換性のガイドライン

*   **既存フィールドの削除**: 既存のフィールドを削除する場合は、そのフィールドを使用している古いバージョンのクライアントがエラーにならないよう、慎重に計画してください。可能であれば、非推奨としてマークし、段階的に削除します。
*   **フィールド名の変更**: フィールド名を変更する場合は、古い名前と新しい名前の両方をサポートする期間を設けるか、マイグレーションロジックで変換を行います。
*   **フィールドの追加**: 新しいフィールドを追加する場合は、古いバージョンのクライアントがそのフィールドを無視できるように、デフォルト値を設定することを検討してください。
*   **API バージョニング**: 大規模なスキーマ変更の場合は、API バージョニング（例: `/api/v1/plans`, `/api/v2/plans`）を検討し、クライアントが特定のバージョンの API を使用できるようにします。

## 3. `Plan.schemaVersion` を使った移行戦略

`StudyPlan` モデルに `schemaVersion` フィールドを導入することで、以下のような段階的な移行戦略が可能になります。

1.  **アプリケーションのデプロイ**: 新しい `schemaVersion` を持つアプリケーションをデプロイします。この時点では、古いスキーマのデータはそのままです。
2.  **データ読み込み時のオンデマンドマイグレーション**: アプリケーションが古いスキーマのデータを読み込む際、`schemaVersion` をチェックし、必要に応じて新しいスキーマに変換します。この変換されたデータは、新しいスキーマで保存されます。これにより、ユーザーがアプリを使用するにつれてデータが徐々に新しいスキーマに移行されます。
3.  **バッチマイグレーション（オプション）**: 大量のデータを一度に移行する必要がある場合は、バックエンドでバッチ処理を実行してデータを移行することも検討します。これは、特に古いバージョンのクライアントがほとんど存在しない場合に有効です。

この戦略により、ダウンタイムなしでスキーマ変更をデプロイし、ユーザーに影響を与えることなくデータを移行できます。
